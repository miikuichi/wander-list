{% extends 'base.html' %}

{% block title %}PisoHeroes | Log Expense{% endblock %}

{% block content %}
<main class="container-fluid flex-grow-1 dashboard-content"> 
    
    <h1 class="dashboard-title">Log Expense</h1>

    <!-- Wallet Balance Summary Card -->
    <div class="card mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="card-body">
            <h3 class="mb-3"><i class="fas fa-wallet"></i> Today's Wallet Balance</h3>
            <div class="row g-3">
                <div class="col-md-3">
                    <small class="d-block opacity-75">Opening Balance</small>
                    <h4 class="mb-0">₱{{ wallet.opening_balance|floatformat:2 }}</h4>
                    <small class="opacity-75">Carried from yesterday</small>
                </div>
                <div class="col-md-3">
                    <small class="d-block opacity-75">Daily Allowance</small>
                    <h4 class="mb-0">+ ₱{{ wallet.daily_allowance|floatformat:2 }}</h4>
                    <small class="opacity-75">Today's base budget</small>
                </div>
                <div class="col-md-3">
                    <small class="d-block opacity-75">Extra Income</small>
                    <h4 class="mb-0">+ ₱{{ wallet.daily_income|floatformat:2 }}</h4>
                    <small class="opacity-75">Tips, gifts, etc.</small>
                </div>
                <div class="col-md-3">
                    <small class="d-block opacity-75">Total Available</small>
                    <h4 class="mb-0 fw-bold">₱{{ wallet.total_available|floatformat:2 }}</h4>
                </div>
            </div>
            <hr class="my-3 opacity-25">
            <div class="row">
                <div class="col-md-6">
                    <small class="d-block opacity-75">Spent Today</small>
                    <h4 class="mb-0 text-warning">- ₱{{ wallet.today_expenses|floatformat:2 }}</h4>
                </div>
                <div class="col-md-6">
                    <small class="d-block opacity-75">Remaining (Carries to Tomorrow)</small>
                    <h3 class="mb-0 fw-bold {% if wallet.closing_balance < 0 %}text-danger{% else %}remaining-balance-positive{% endif %}">
                        ₱{{ wallet.closing_balance|floatformat:2 }}
                    </h3>
                    <small class="opacity-75">{{ wallet.percent_used|floatformat:0 }}% used</small>
                </div>
            </div>
        </div>
    </div>

    <div class="g-4 mb-4 content-panels">
        <div class="row g-4">
            <!-- Add Income Card (First) -->
            <div class="col-12">
                <div class="card log-income-card">
                    <div class="card-body">
                        <h2><i class="fas fa-plus-circle text-success"></i> Add Extra Income</h2>
                        <p class="card-subtitle">Log tips, gifts, side hustles, and other income to boost your daily budget.</p>

                        <form method="post" action="{% url 'add_income' %}" class="income-form">
                            {% csrf_token %}

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="income-amount">Amount:</label>
                                        <div class="input-with-icon">
                                            <span>₱</span>
                                            <input type="number" 
                                                   id="income-amount" 
                                                   name="amount" 
                                                   step="0.01" 
                                                   min="0.01" 
                                                   max="999999999.99"
                                                   class="form-control" 
                                                   placeholder="0.00"
                                                   required>
                                        </div>
                                        <small class="form-text text-muted">Enter income amount</small>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="income-source">Source:</label>
                                        <select id="income-source" name="source" class="form-control" required>
                                            <option value="">-- Select Source --</option>
                                            {% for source in income_sources %}
                                                <option value="{{ source }}">{{ source }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mt-3">
                                <label for="income-date">Date:</label>
                                <input type="date" 
                                       id="income-date" 
                                       name="date" 
                                       class="form-control" 
                                       value="{% now 'Y-m-d' %}" 
                                       max="{% now 'Y-m-d' %}"
                                       required>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> Income is added to your wallet balance.
                                </small>
                            </div>

                            <div class="form-group mt-3">
                                <label for="income-notes">Notes (optional):</label>
                                <textarea id="income-notes" 
                                          name="notes" 
                                          class="form-control" 
                                          rows="3" 
                                          placeholder="Add any additional details..."></textarea>
                            </div>

                            <div class="form-actions d-flex justify-content-end gap-3 mt-4">
                                <button type="reset" class="btn btn-outline-secondary">Clear Form</button>
                                <button type="submit" class="btn btn-success"><i class="fas fa-plus"></i> Add Income</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Log New Expense Card (Second) -->
            <div class="col-12">
                <div class="card log-expense-card">
                    <div class="card-body">
                        <h2><i class="fas fa-minus-circle text-danger"></i> Log New Expense</h2>
                        <p class="card-subtitle">Quickly add and categorize your daily expenses to keep track of your spending.</p>

                        <form method="post" action="" class="expense-form">
                        {% csrf_token %}

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="amount">Amount:</label>
                                    <div class="input-with-icon">
                                        <span>₱</span>
                                        <input type="number" 
                                               id="amount" 
                                               name="amount" 
                                               step="0.01" 
                                               min="0.01" 
                                               max="999999999.99"
                                               class="form-control" 
                                               placeholder="0.00"
                                               required>
                                    </div>
                                    <small class="form-text text-muted">Enter amount greater than zero</small>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="category">Category:</label>
                                    <select id="category" name="category" class="form-control" required>
                                        <option value="">-- Select Category --</option>
                                        {% for cat in categories %}
                                            <option value="{{ cat }}">{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mt-3">
                            <label for="date">Date:</label>
                            <input type="date" 
                                   id="date" 
                                   name="date" 
                                   class="form-control" 
                                   value="{% now 'Y-m-d' %}" 
                                   max="{% now 'Y-m-d' %}"
                                   required>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i> Defaults to today. Daily allowance tracking is based on expense date.
                            </small>
                        </div>

                        <div class="form-group mt-3">
                            <label for="notes">Notes (optional):</label>
                            <textarea id="notes" 
                                      name="notes" 
                                      class="form-control" 
                                      rows="3" 
                                      placeholder="Add any additional details..."></textarea>
                        </div>

                        <div class="form-actions d-flex justify-content-end gap-3 mt-4">
                            <button type="reset" class="btn btn-outline-secondary">Clear Form</button>
                            <button type="submit" class="btn btn-success">Add Expense</button>
                        </div>
                    </form>

                    <script>
                        // Client-side validation for expense form
                        document.querySelector('.expense-form').addEventListener('submit', function(e) {
                            const amount = parseFloat(document.getElementById('amount').value);
                            const category = document.getElementById('category').value;
                            
                            // Validate amount
                            if (isNaN(amount) || amount <= 0) {
                                e.preventDefault();
                                alert('⚠️ Please enter a valid amount greater than zero.');
                                return false;
                            }
                            
                            if (amount > 999999999.99) {
                                e.preventDefault();
                                alert('⚠️ Amount is too large. Maximum is ₱999,999,999.99');
                                return false;
                            }
                            
                            // Validate category
                            if (!category || category === '') {
                                e.preventDefault();
                                alert('⚠️ Please select a category.');
                                return false;
                            }
                            
                            return true;
                        });
                        
                        // Prevent negative values on input
                        document.getElementById('amount').addEventListener('input', function(e) {
                            if (this.value < 0) {
                                this.value = 0;
                            }
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Expenses Section -->
    <div class="card recent-expenses-card mt-4 mb-4">
        <div class="card-body">
            <h2 class="mb-3"><i class="fas fa-receipt"></i> Recent Expenses</h2>
                    
                    <div class="expense-list">
                        {% for expense in recent_expenses %}
                            <div class="expense-item d-flex justify-content-between align-items-center py-3 border-bottom">
                                <div class="expense-details flex-grow-1">
                                    <div class="d-flex align-items-center gap-3">
                                        <span class="expense-category fw-bold">{{ expense.category }}</span>
                                        <span class="expense-date text-muted small">{{ expense.date }}</span>
                                    </div>
                                    {% if expense.notes %}
                                        <div class="expense-notes text-muted small mt-1">{{ expense.notes }}</div>
                                    {% endif %}
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="expense-amount text-danger fw-semibold">₱{{ expense.amount }}</span>
                                    <button class="btn btn-sm btn-outline-primary edit-btn" 
                                            data-id="{{ expense.id }}"
                                            data-amount="{{ expense.amount }}"
                                            data-category="{{ expense.category }}"
                                            data-date="{{ expense.date }}"
                                            data-notes="{{ expense.notes }}"
                                            title="Edit expense">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <form method="post" action="{% url 'delete_expense' expense.id %}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this expense?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete expense">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        {% empty %}
                            <div class="text-muted text-center py-4">
                                <i class="fas fa-inbox fa-3x mb-3 text-muted"></i>
                                <p>No expenses yet. Start tracking your spending!</p>
                            </div>
                        {% endfor %}
                    </div>
                
        </div>
    </div>
</main>

    <!-- Edit Expense Modal -->
    <div class="modal fade" id="editExpenseModal" tabindex="-1" aria-labelledby="editExpenseModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editExpenseModalLabel">Edit Expense</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post" id="editExpenseForm">
                    {% csrf_token %}
                    <div class="modal-body">
                        <input type="hidden" id="edit-expense-id" name="expense_id">
                        
                        <div class="mb-3">
                            <label for="edit-amount" class="form-label">Amount:</label>
                            <div class="input-group">
                                <span class="input-group-text">₱</span>
                                <input type="number" 
                                       id="edit-amount" 
                                       name="amount" 
                                       step="0.01" 
                                       min="0.01" 
                                       max="999999999.99"
                                       class="form-control" 
                                       required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="edit-category" class="form-label">Category:</label>
                            <select id="edit-category" name="category" class="form-control" required>
                                <option value="">-- Select Category --</option>
                                {% for cat in categories %}
                                    <option value="{{ cat }}">{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="edit-date" class="form-label">Date:</label>
                            <input type="date" id="edit-date" name="date" class="form-control" required>
                        </div>

                        <div class="mb-3">
                            <label for="edit-notes" class="form-label">Notes (optional):</label>
                            <textarea id="edit-notes" name="notes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Expense</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Handle edit button clicks
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const expenseId = this.dataset.id;
                const amount = this.dataset.amount;
                const category = this.dataset.category;
                const date = this.dataset.date;
                const notes = this.dataset.notes;

                // Populate the modal form
                document.getElementById('edit-expense-id').value = expenseId;
                document.getElementById('edit-amount').value = amount;
                document.getElementById('edit-category').value = category;
                document.getElementById('edit-date').value = date;
                document.getElementById('edit-notes').value = notes;

                // Update form action URL
                document.getElementById('editExpenseForm').action = `/expenses/edit/${expenseId}/`;

                // Show the modal
                const modal = new bootstrap.Modal(document.getElementById('editExpenseModal'));
                modal.show();
            });
        });

        // Validate edit form
        document.getElementById('editExpenseForm').addEventListener('submit', function(e) {
            const amount = parseFloat(document.getElementById('edit-amount').value);
            const category = document.getElementById('edit-category').value;
            
            if (isNaN(amount) || amount <= 0) {
                e.preventDefault();
                alert('⚠️ Please enter a valid amount greater than zero.');
                return false;
            }
            
            if (amount > 999999999.99) {
                e.preventDefault();
                alert('⚠️ Amount is too large. Maximum is ₱999,999,999.99');
                return false;
            }
            
            if (!category || category === '') {
                e.preventDefault();
                alert('⚠️ Please select a category.');
                return false;
            }
            
            return true;
        });
    </script>
{% endblock %}