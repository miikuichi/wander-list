{% extends 'base.html' %}
{% load static %}

{% block title %}Audit Logs - PisoHeroes{% endblock %}

{% block extra_css %}
<style>
    .audit-header {
        background: linear-gradient(135deg, #34c54a 0%, #28a745 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(52, 197, 74, 0.2);
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #34c54a;
        margin: 0.5rem 0;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .filter-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .logs-table {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table thead {
        background-color: #f8f9fa;
    }
    
    .badge-create { background-color: #28a745; }
    .badge-read { background-color: #17a2b8; }
    .badge-update { background-color: #ffc107; color: #000; }
    .badge-delete { background-color: #dc3545; }
    .badge-login { background-color: #007bff; }
    .badge-logout { background-color: #6c757d; }
    .badge-failed { background-color: #dc3545; }
    .badge-denied { background-color: #fd7e14; }
    .badge-breach { background-color: #e83e8c; }
    .badge-alert { background-color: #6610f2; }
    
    .metadata-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        color: #dee2e6;
        margin-bottom: 1rem;
    }
    
    .export-btn {
        background-color: #34c54a;
        border-color: #34c54a;
        color: white;
    }
    
    .export-btn:hover {
        background-color: #28a745;
        border-color: #28a745;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="audit-header">
        <h1><i class="fas fa-clipboard-list"></i> Audit Logs</h1>
        <p class="mb-0">Track all your activities and system events for security and compliance</p>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-label">Total Actions</div>
                <div class="stat-value">{{ total_actions }}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-label">Created</div>
                <div class="stat-value text-success">{{ create_count }}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-label">Updated</div>
                <div class="stat-value text-warning">{{ update_count }}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-label">Deleted</div>
                <div class="stat-value text-danger">{{ delete_count }}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-label">Logins</div>
                <div class="stat-value text-primary">{{ login_count }}</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="stat-card">
                <div class="stat-label">Failed Logins</div>
                <div class="stat-value text-danger">{{ failed_login_count }}</div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filter-card">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label"><i class="fas fa-filter"></i> Action Type</label>
                <select name="action_type" class="form-select">
                    <option value="">All Actions</option>
                    {% for value, label in action_types %}
                        <option value="{{ value }}" {% if selected_action == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label"><i class="fas fa-database"></i> Resource Type</label>
                <select name="resource_type" class="form-select">
                    <option value="">All Resources</option>
                    {% for value, label in resource_types %}
                        <option value="{{ value }}" {% if selected_resource == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label"><i class="fas fa-calendar"></i> Days</label>
                <select name="days" class="form-select">
                    <option value="7" {% if selected_days == 7 %}selected{% endif %}>Last 7 days</option>
                    <option value="30" {% if selected_days == 30 %}selected{% endif %}>Last 30 days</option>
                    <option value="90" {% if selected_days == 90 %}selected{% endif %}>Last 90 days</option>
                    <option value="365" {% if selected_days == 365 %}selected{% endif %}>Last year</option>
                    <option value="0" {% if selected_days == 0 %}selected{% endif %}>All time</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label"><i class="fas fa-search"></i> Search</label>
                <input type="text" name="search" class="form-control" placeholder="Resource ID or IP" value="{{ search_query }}">
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-search"></i> Apply Filters
                </button>
            </div>
        </form>
        <div class="mt-3">
            <a href="{% url 'audit_logs:export' %}?action_type={{ selected_action }}&resource_type={{ selected_resource }}&days={{ selected_days }}" 
               class="btn export-btn">
                <i class="fas fa-download"></i> Export to CSV
            </a>
        </div>
    </div>
    
    <!-- Logs Table -->
    {% if logs %}
    <div class="logs-table">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Action</th>
                    <th>Resource</th>
                    <th>Resource ID</th>
                    <th>IP Address</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>{{ log.timestamp|date:"Y-m-d H:i:s" }}</td>
                    <td>
                        <span class="badge badge-{{ log.action_type|lower }}">
                            {{ log.get_action_type_display }}
                        </span>
                    </td>
                    <td>{{ log.get_resource_type_display }}</td>
                    <td>{{ log.resource_id|default:"—" }}</td>
                    <td>{{ log.ip_address|default:"—" }}</td>
                    <td class="metadata-cell" title="{{ log.get_metadata_display }}">
                        {% if log.metadata %}
                            {{ log.metadata|truncatechars:50 }}
                        {% else %}
                            —
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-clipboard-list"></i>
        <h3>No Audit Logs Found</h3>
        <p>No logs match your current filters. Try adjusting your search criteria.</p>
    </div>
    {% endif %}
    
    {% if total_actions > 100 %}
    <div class="alert alert-info mt-3">
        <i class="fas fa-info-circle"></i> Showing the 100 most recent logs. Use filters to narrow down results or export to CSV for the full dataset.
    </div>
    {% endif %}
</div>
{% endblock %}
