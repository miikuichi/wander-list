{% extends 'base.html' %}

{% block title %}PisoHeroes | Home Dashboard{% endblock %}

{% block content %}
<main class="container-fluid flex-grow-1 dashboard-content"> 
    
    <h1 class="dashboard-title">Home Dashboard</h1>

    <div class="row g-4 mb-4">
        <!-- DAILY ALLOWANCE -->
        <div class="col-lg-4 col-md-6">
    <div class="card daily-allowance-card h-100">
        <div class="card-body">
            <h5 class="card-header d-flex justify-content-between align-items-center">
                Daily Allowance <i class="fas fa-calendar-alt text-muted"></i>
            </h5>
            <p class="text-muted mb-1">Your financial snapshot today</p>

            <!-- Display computed daily allowance (falls back to 500.00) -->
            <h2 class="total-amount mb-0">Total: ₱{{ daily_allowance|floatformat:2|default:"500.00" }}</h2>
            <p class="spent-remaining mb-0">Spent: ₱{{ today_expenses|floatformat:2|default:"0.00" }}</p>
            <p class="spent-remaining fs-5 fw-bold {% if remaining_today >= 0 %}text-success{% else %}text-danger{% endif %}">
                Remaining: ₱{{ remaining_today|floatformat:2|default:"500.00" }}
            </p>
            <hr>
            <small class="text-muted">
                This week: ₱{{ week_expenses|floatformat:2|default:"0.00" }}<br>
                This month: ₱{{ month_expenses|floatformat:2|default:"0.00" }}
            </small>

            <!-- ---------- Monthly allowance form (inline, no JS) ---------- -->
            <hr class="my-3">
<form id="monthlyForm" method="post" action="{% url 'update_monthly_allowance' %}" class="mt-2" novalidate>
    {% csrf_token %}
    <div class="mb-2">
        <label for="monthly_allowance" class="form-label small">Monthly allowance (₱)</label>
        <input
            id="monthly_allowance"
            name="monthly_allowance"
            type="number"
            step="0.01"
            min="0"
            value="{{ monthly_allowance|default_if_none:'' }}"
            class="form-control form-control-sm"
            placeholder="e.g. 10000.00"
            aria-describedby="monthlyHelp"
            disabled
            required
        />
        <div id="monthlyHelp" class="form-text small text-muted">
            If set, Daily Allowance = Monthly ÷ {{ days_in_month|default:"30" }} days.
        </div>
    </div>

    <div class="d-flex gap-2 align-items-center">
        <!-- Edit shown initially -->
        <button id="editMonthlyBtn" type="button" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-edit me-1"></i> Edit
        </button>

        <!-- Save + Cancel hidden until edit -->
        <button id="saveMonthlyBtn" type="submit" class="btn btn-primary btn-sm d-none" disabled>
            <i class="fas fa-save me-1"></i> Save
        </button>

        <button id="cancelMonthlyBtn" type="button" class="btn btn-outline-secondary btn-sm d-none">
            Cancel
        </button>

        <!-- Optional inline status -->
        <small id="monthlyStatus" class="text-muted ms-3 d-none">Editing...</small>
    </div>
</form>

<script>
(function() {
  const form = document.getElementById('monthlyForm');
  const input = document.getElementById('monthly_allowance');
  const editBtn = document.getElementById('editMonthlyBtn');
  const saveBtn = document.getElementById('saveMonthlyBtn');
  const cancelBtn = document.getElementById('cancelMonthlyBtn');
  const status = document.getElementById('monthlyStatus');

  // Keep original value to allow cancel/revert
  let originalValue = input.value;

  function enterEditMode() {
    originalValue = input.value;
    input.removeAttribute('disabled');
    input.focus();
    editBtn.classList.add('d-none');

    saveBtn.classList.remove('d-none');
    saveBtn.removeAttribute('disabled');

    cancelBtn.classList.remove('d-none');
    status.classList.remove('d-none');
  }

  function exitEditMode(revert=false) {
    if (revert) {
      input.value = originalValue;
    }
    input.setAttribute('disabled', 'disabled');
    editBtn.classList.remove('d-none');

    saveBtn.classList.add('d-none');
    saveBtn.setAttribute('disabled', 'disabled');

    cancelBtn.classList.add('d-none');
    status.classList.add('d-none');
  }

  editBtn.addEventListener('click', function(e) {
    enterEditMode();
  });

  cancelBtn.addEventListener('click', function(e) {
    exitEditMode(true);
  });

  // Prevent accidental submit if somehow button not disabled
  form.addEventListener('submit', function(e) {
    if (saveBtn.disabled) {
      // not in edit mode — block submission
      e.preventDefault();
      return;
    }
    // Optional: you may want a confirm dialog or client-side validation here
    // e.g. if input is empty or < 0 => prevent and show message
    const val = parseFloat(input.value);
    if (Number.isNaN(val) || val < 0) {
      e.preventDefault();
      alert('Please enter a valid non-negative monthly amount before saving.');
      input.focus();
      return;
    }
    // Allow submit to proceed; the server will handle saving and redirect
  });

  // If user presses ESC while editing -> cancel
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      exitEditMode(true);
    }
  });

  // Initialize (ensure inputs/buttons are in starting state)
  exitEditMode(true);
})();
</script>

        </div>
    </div>
</div>

        <!-- BUDGET USAGE (Pie Chart) -->
        <div class="col-lg-4 col-md-6">
            <div class="card h-100">
                <div class="card-body">
                    <h5 class="card-header d-flex justify-content-between align-items-center">
                        Budget Usage <i class="fas fa-chart-pie text-muted"></i>
                    </h5>

                    <!-- NEW: period label + toggle buttons -->
                    <div class="d-flex justify-content-between align-items-center mt-2 mb-3">
                        <p class="text-muted mb-0">
                            Spending breakdown by category
                            (<span id="budget-period-text">this month</span>)
                        </p>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Budget period selector">
                            <button type="button" class="btn btn-outline-primary active" data-period="monthly">
                                Monthly
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-period="weekly">
                                Weekly
                            </button>
                            <button type="button" class="btn btn-outline-primary" data-period="daily">
                                Daily
                            </button>
                        </div>
                    </div>

                    {% if category_spending %}
                    <div style="width:100%; max-width:420px; margin:0 auto;">
                        <canvas id="budgetPieChart"></canvas>
                    </div>
                    <div id="budget-legend" class="mt-3"></div>
                    {% else %}
                        <p class="text-muted text-center py-3">No budget data available. Start by logging expenses!</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- QUICK ACTIONS -->
        <div class="col-lg-4 col-md-12">
            <div class="card quick-actions-card h-100">
                <div class="card-body d-flex flex-column justify-content-center">
                    <h5 class="card-header mb-3">Quick Actions</h5>
                    <a href="{% url 'expenses' %}" class="btn btn-success btn-lg mb-2">
                        <i class="fas fa-plus me-2"></i> Log Expense
                    </a>
                    <a href="{% url 'savings_goals:goals' %}" class="btn btn-outline-secondary btn-lg mb-2">
                        <i class="fas fa-piggy-bank me-2"></i> Add Savings Goal
                    </a>
                    <a href="{% url 'alerts_page' %}" class="btn btn-outline-info btn-lg">
                        <i class="fas fa-bell me-2"></i> Manage Budgets
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- RECENT EXPENSES -->
    {% if recent_expenses %}
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Recent Expenses</h5>
                <a href="{% url 'expenses' %}" class="btn btn-link btn-sm">View All</a>
            </div>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Notes</th>
                            <th class="text-end">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for expense in recent_expenses %}
                        <tr>
                            <td>{{ expense.date }}</td>
                            <td><span class="badge bg-secondary">{{ expense.category }}</span></td>
                            <td>{{ expense.notes|truncatewords:5|default:"—" }}</td>
                            <td class="text-end text-danger fw-bold">₱{{ expense.amount|floatformat:2 }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- SAVINGS GOALS -->
    <div class="savings-goals-section">
        <div class="header">
            <h2>Savings Goals Overview</h2>
            <a href="{% url 'savings_goals:goals' %}" class="btn btn-link">
                <i class="fas fa-redo text-muted"></i>
            </a>
        </div>
        <p class="text-muted mb-4">Keep track of your progress towards financial dreams.</p>

        {% if active_goals %}
            <div class="row g-4">
                {% for goal in active_goals %}
                <div class="col-lg-4 col-md-6">
                    <div class="card goal-card h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">{{ goal.name }}</h5>
                            {% if goal.description %}
                                <p class="text-muted small mb-3">{{ goal.description|truncatewords:10 }}</p>
                            {% endif %}
                            <p class="amounts mb-1">₱{{ goal.current_amount|floatformat:2 }} / ₱{{ goal.target_amount|floatformat:2 }}</p>
                            <div class="progress mb-2">
                                <div class="progress-bar {% if goal.is_complete %}bg-success{% else %}bg-primary{% endif %}" 
                                     role="progressbar" 
                                     style="width: {{ goal.progress_percentage }}%;" 
                                     aria-valuenow="{{ goal.progress_percentage }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <small class="percentage text-muted">{{ goal.progress_percentage }}% Complete</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="text-end mt-4">
                <a href="{% url 'savings_goals:goals' %}" class="btn btn-link text-decoration-none">
                    View All Goals <i class="fas fa-arrow-right ms-2"></i>
                </a>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-piggy-bank fa-3x text-muted mb-3"></i>
                <p class="text-muted mb-3">No savings goals yet. Start planning for your future!</p>
                <a href="{% url 'savings_goals:goals' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Create Your First Goal
                </a>
            </div>
        {% endif %}
    </div>
</main>

<!-- Chart.js for Pie Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  // Only proceed if we have monthly data (same as old check)
  {% if category_spending and category_spending|length > 0 %}

    // --- NEW: Prepare data from Django context for all three periods ---
    const budgetData = {
      daily: [
        {% for cat in category_spending_daily %}
        { name: "{{ cat.name|escapejs }}", spent: {{ cat.spent|floatformat:2|default:"0.00" }} }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      weekly: [
        {% for cat in category_spending_weekly %}
        { name: "{{ cat.name|escapejs }}", spent: {{ cat.spent|floatformat:2|default:"0.00" }} }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      monthly: [
        {% for cat in category_spending_monthly %}
        { name: "{{ cat.name|escapejs }}", spent: {{ cat.spent|floatformat:2|default:"0.00" }} }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ]
    };

    const palette = [
      '#2b9bf4','#28c76f','#ff9f43','#ea5455','#7367f0',
      '#00cfe8','#f8686b','#a8a8a8','#ffd166','#06d6a0'
    ];

    const ctx = document.getElementById('budgetPieChart').getContext('2d');
    const legendContainer = document.getElementById('budget-legend');
    const periodTextSpan = document.getElementById('budget-period-text');
    const periodButtons = document.querySelectorAll('[data-period]');
    let currentPeriod = 'monthly';
    let chartInstance = null;

    function renderChart(period) {
      const items = budgetData[period] || [];

      const labels = items.map(i => i.name);
      const dataValues = items.map(i => i.spent);
      const backgroundColors = labels.map((_, i) => palette[i % palette.length]);

      // Destroy previous instance if exists
      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: dataValues,
            backgroundColor: backgroundColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const formatted = new Intl.NumberFormat('en-PH', {
                    style: 'currency',
                    currency: 'PHP'
                  }).format(value);
                  return `${label}: ${formatted}`;
                }
              }
            }
          }
        }
      });

      // Build legend
      const total = dataValues.reduce((a, b) => a + b, 0);
      let html = '<ul class="list-unstyled mb-0">';
      labels.forEach((label, i) => {
        const value = dataValues[i] || 0;
        const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
        const formattedAmt = new Intl.NumberFormat('en-PH', {
          style: 'currency',
          currency: 'PHP'
        }).format(value);
        html += `<li>
          <span style="display:inline-block;width:12px;height:12px;background:${backgroundColors[i]};margin-right:6px;border-radius:2px;"></span>
          ${label}: ${formattedAmt} (${pct}%)
        </li>`;
      });
      html += '</ul>';
      legendContainer.innerHTML = html;

      // Update period label
      if (period === 'daily') {
        periodTextSpan.textContent = 'today';
      } else if (period === 'weekly') {
        periodTextSpan.textContent = 'this week';
      } else {
        periodTextSpan.textContent = 'this month';
      }
    }

    // Handle period button clicks
    periodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const period = btn.getAttribute('data-period');
        if (period === currentPeriod) return;

        currentPeriod = period;

        // Toggle active class
        periodButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        renderChart(period);
      });
    });

    // Initial render (monthly by default)
    renderChart('monthly');

  {% endif %}
});
</script>
{% endblock %}
